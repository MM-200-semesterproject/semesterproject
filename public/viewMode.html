<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Viewing</title>
    <link rel="stylesheet" type="text/css" href="styles/global.css" />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Limelight&family=Roboto:wght@100;400;500;900&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/x-icon" href="favicon.ico" />
  </head>

  <body>
    <header class="header">
      <img src="svg/logo.svg" alt="More Slides logo" id="headerLogo" />
      <div>
        <button class="btnGrey editIcon" style="display: block">
          <a href="editMode.html" id="editBtnLink">A</a>
          <img class="appIcon" src="svg/editIcon.svg" />
        </button>

        <button class="selectBtn" id="userIcon">
          u
          <div class="selectOptions">
            <p id="logInUser">Go to Login</p>
          </div>
        </button>
      </div>
    </header>

    <div class="editWrapper">
      <div class="editActiveArea">
        <div class="aspectRatio">
          <div id="slideDiv" class="slideShowbodyDefault">
            <a class="prev" onclick="navigate(-1)">&#8249;</a>
            <div id="container" class="slideContent"></div>
            <a class="next" onclick="navigate(1)">&#8250;</a>
          </div>
        </div>

        <div id="navDots" style="text-align: center">
          <span id="dot"></span>
        </div>
      </div>
      <div class="editMenu" style="justify-content: space-evenly">
        <section class="menuSection">
          <h2>Choose public presentation:</h2>
          <button class="selectBtn" id="selectBtn">
            <span id="presTitleDisplay"></span
            ><span class="dropdownArw" id="dropdownArw"></span>
            <div id="presList" class="selectOptions"></div>
          </button>
        </section>

        <section class="menuSection">
          <button id="presentMode" class="btnGreen">
            Presentation mode<img class="appIcon" src="svg/expand.svg" />
          </button>
        </section>
      </div>
    </div>

    <script type="text/javascript">
      const editBtnLink = document.querySelector('#editBtnLink');

      const container = document.getElementById('container');
      const addList = document.getElementById('addList');
      const slideDiv = document.querySelector('#slideDiv');

      const presList = document.querySelector('#presList');
      const editMenu = document.querySelector('.editMenu');
      const presModeBtn = document.querySelector('#presentMode');
      const displayTitle = document.querySelector('#presTitleDisplay');
      const editBtn = document.querySelector('.editIcon');
      const logInUser = document.querySelector('#logInUser');

      let showIndex = 0;
      let userInputImgURL;

      let presentationObject = localStorage.getItem('presentations')
        ? JSON.parse(localStorage.getItem('presentations'))
        : false;

      let presentationArray = [];

      presModeBtn.onclick = () => {
        editMenu.style.display = 'none';
        slideDiv.style.margin = '1% 6% auto';
        slideDiv.style.width = '88%';
        slideDiv.style.height = '88%';
        editBtnLink.style.display = 'none';
      };

      editBtn.onclick = () => {
        if ((editMenu.style.display = 'flex')) {
          editBtnLink.style.display = 'block';
        }
        exitFullscreen();
      };

      logInUser.onclick = () => (location.href = 'login.html');

      window.addEventListener('keydown', (e) => {
        if (e.key == 'ArrowLeft') {
          navigate(-1);
        } else if (e.key == 'ArrowRight') {
          navigate(1);
        }
        if (e.key == 'Escape') {
          if (editMenu.style.display === 'none') {
            exitFullscreen();
          }
        }
      });

      function exitFullscreen() {
        editMenu.style.display = 'flex';
        slideDiv.style.margin = 'auto 10% 4%';
        slideDiv.style.width = '80%';
        slideDiv.style.height = '80%';
      }

      function updatePresentationArray() {
        presentationObject = localStorage.getItem('presentations')
          ? JSON.parse(localStorage.getItem('presentations'))
          : false;

        if (
          !presentationObject ||
          !presentationObject.arr ||
          presentationObject == false
        ) {
          presentationArray = [{ title: 'empty' }];
          createPresList();
        } else if (presentationObject.arr.length == 0) {
          presentationArray = [{ title: 'empty' }];
          createPresList();
        } else if (presentationObject.arr.length > 0) {
          presentationArray = [];
          for (let i = 0; i < presentationObject.arr.length; i++) {
            presentationArray.unshift(presentationObject.arr[i]);
          }
          loadPresentationToView(presentationArray[0]);
          createPresList();
        } else {
        }
      }

      function activeSlide(n) {
        loadSlides((showIndex = n));
      }
      function navigate(num) {
        loadSlides((showIndex += num));
      }

      function createNavigationDots(numberOfslides) {
        let navDots = document.getElementById('navDots');
        navDots.innerHTML = '';
        for (let i = 0; i <= numberOfslides; i++) {
          let span = document.createElement('span');
          span.classList.add('dot');
          span.addEventListener('click', function (evt) {
            activeSlide(i);
          });
          navDots.appendChild(span);
        }
      }

      function loadPresentationToView(currentPres) {
        displayTitle.innerHTML = currentPres.title;
        createNavigationDots(currentPres.data.length);
        container.innerHTML = '';
        let titleDiv = document.createElement('div');
        titleDiv.innerHTML = `<h6>${currentPres.title}</h6>`;
        titleDiv.classList.add('slide');
        container.appendChild(titleDiv);
        for (let slide of currentPres.data) {
          let div = document.createElement('div');

          let html = '';
          let text = '';
          let img = '';
          let list = '';

          if (slide.text) {
            text = '<h6>' + slide.text + '</h6>';
          }
          if (slide.img) {
            img = '<img src=' + slide.img + ' >';
          }
          if (slide.list) {
            let innerOl = slide.list;
            list = '<ul>' + innerOl + '</ul>';
          }
          div.classList.add('slide');
          html = `${text}
                  ${img}
                  ${list}`;
          div.innerHTML = html;

          container.appendChild(div);
        }
        loadSlides(showIndex);
      }

      function loadSlides(num) {
        let slideshow = document.getElementsByClassName('slide');
        let dots = document.getElementsByClassName('dot');
        if (num >= slideshow.length) {
          showIndex = 0;
        }
        if (num < 0) {
          showIndex = slideshow.length - 1;
        }
        for (let i = 0; i < slideshow.length; i++) {
          slideshow[i].style.display = 'none';
        }
        for (let i = 0; i < dots.length; i++) {
          dots[i].className = dots[i].className.replace(' crntSlide', '');
        }
        slideshow[showIndex];

        slideshow[showIndex].style.display = 'flex';

        dots[showIndex].className += ' crntSlide';
      }

      function createPresList() {
        presList.innerHTML = '';
        if (presentationArray[0].length == 0 || !presentationArray[0].title) {
          displayTitle.innerHTML = 'empty';
        } else if (!presentationArray[0]) {
          displayTitle.innerHTML = 'Undefined';
        } else {
          displayTitle.innerHTML = presentationArray[0].title;
        }
        for (let part of presentationArray) {
          let p = document.createElement('p');
          p.id = part.presentationid;
          p.classList.add('presOption');
          p.title = part.title;
          p.innerHTML = part.title;
          p.id = part.presentationid;
          p.addEventListener('click', function () {
            displayTitle.innerHTML = p.title;
            for (let i = 0; i < presentationArray.length; i++) {
              if (p.id == presentationArray[i].presentationid) {
                let newPres = presentationArray.splice(i, 1);
                presentationArray.unshift(newPres[0]);
              }
            }
            loadPresentationToView(presentationArray[0]);
          });
          presList.appendChild(p);
        }
      }

      window.onload = function () {
        const body = {
          published: 'PUBLIC',
        };
        const config = {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body),
        };

        fetch(`/public-list`, config)
          .then((resp) => {
            if (resp.status !== 200) {
              throw new Error('Could not Load presentations');
            }
            return resp.json();
          })
          .then((resp) => {
            const presentationObject = JSON.stringify(resp);
            localStorage.setItem('presentations', presentationObject);
            updatePresentationArray();
          })
          .catch((err) => {
            console.log(err);
            return err;
          });
      };
    </script>
  </body>
</html>
